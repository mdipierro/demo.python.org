<!doctype html>
<html lang="en">
  <head>
    
    <!-- about/success/cog -->
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta charset="utf-8" />
    <title>
      Python.org
    </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <!-- le html5 shim, for ie6-8 support of html elements -->
    <!--[if lt ie 9]>
        <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
    <!-- le styles -->
    
    <script type="text/javascript"><!--
    // These variables are used by the web2py_ajax_init function in web2py_ajax.js (which is loaded below).
    var w2p_ajax_confirm_message = "Are you sure you want to delete this object?";
    var w2p_ajax_date_format = "%Y-%m-%d";
    var w2p_ajax_datetime_format = "%Y-%m-%d %H:%M:%S";
    //--></script>
<meta name="keywords" content="web2py, python, framework" /><meta name="copyright" content="Copyright 2011" /><meta name="description" content="a cool new app" /><meta name="generator" content="Web2py Web Framework" /><meta name="author" content="Your Name &lt;you@example.com&gt;" /><script src="/pythonorg/static/js/jquery.js" type="text/javascript"></script><link href="/pythonorg/static/css/calendar.css" rel="stylesheet" type="text/css" /><script src="/pythonorg/static/js/calendar.js" type="text/javascript"></script><script src="/pythonorg/static/js/web2py.js" type="text/javascript"></script><link href="/pythonorg/static/css/web2py.css" rel="stylesheet" type="text/css" /><script src="/pythonorg/static/bootswatch_files/jquery.toc.js" type="text/javascript"></script><link href="http://bootswatch.com/spacelab/bootstrap.min.css" rel="stylesheet" type="text/css" /><link href="http://bootswatch.com/assets/css/bootstrap-responsive.css" rel="stylesheet" type="text/css" /><link href="http://bootswatch.com/css/docs.css" rel="stylesheet" type="text/css" />

    <style>
#content {padding-top: 0px; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 12pt;
 font-weight: 300;line-height: 22.5px;color: #333;}
#content-main img {max-width:200px; padding: 10px;}
#toc { padding: 10px; font-size: 12px; font-height:14px}
#toc ul { margin: 0; padding: 0; list-style: none; }
#toc li { padding: 5px 10px; }
#toc a { text-decoration: none; display: block; }
#toc .toc-h2 { padding-left: 10px;}
#toc .toc-h3 { padding-left: 20px; }
#toc .toc-active { background: #ddd; }
p, li {text-align: justify; line-height: 22.5px;}
#content h1, #content h2, #content h3, #content h4 { 
  padding-top:1em; padding-bottom: 0.5em; 
}
#rst-content h1 {font-size: 28px; text-align: left}
#rst-content h2 {font-size: 24px; text-align: left}
#rst-content h3 {font-size: 20px; text-align: left}
#rst-content h4 {font-size: 16px; text-align: left}
#rst-content pre {background-color: black; border: 0; color:white}
</style>
  </head>
  <body data-spy="scroll" data-target=".subnav" data-offset="50">
    <!-- navbar     ================================================== -->
    <div class="navbar navbar-fixed-top">
      
      <div id="flash" class="flash navbar-inner" style="text-align:center; vertical-align:middle; background: yellow; color:black"></div>
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"> </span>
            <span class="icon-bar"> </span>
            <span class="icon-bar"> </span>
          </a>
          <!--a class="brand" href="http://bootswatch.com/">bootswatch</a-->
          <div class="nav-collapse">
	    <ul class="nav"><li><a href="/pythonorg/default/index">Python.org</a></li><li class="dropdown"><a href="#" onclick="javascript:void(0);return false;">About</a><ul class="dropdown-menu"><li><a href="/pythonorg/default/index/about">Readme</a></li><li><a href="/pythonorg/default/index/about/gettingstarted">Getting Started</a></li><li><a href="/pythonorg/default/index/about/apps">Applications</a></li><li><a href="/pythonorg/default/index/about/success">Success Stories</a></li><li><a href="http://docs.python.org/license.html">License</a></li><li><a href="/pythonorg/default/index/about/help">Help</a></li></ul></li><li class="dropdown"><a href="#" onclick="javascript:void(0);return false;">News</a><ul class="dropdown-menu"><li><a href="/pythonorg/default/index/news">Readme</a></li><li><a href="/pythonorg/default/index/news/security">Security Advisory</a></li><li><a href="/pythonorg/default/index/news/releaseschedule">Release Schedule</a></li></ul></li><li class="dropdown"><a href="#" onclick="javascript:void(0);return false;">Learn</a><ul class="dropdown-menu"><li><a href="https://www.google.com/search?q=python&amp;btnG=Search+Books&amp;tbm=bks&amp;tbo=1#q=python+language&amp;hl=en&amp;tbo=1&amp;tbas=0&amp;tbs=vw:g,bkt:b,cdr:1,cd_min:2000,cd_max:2099&amp;tbm=bks&amp;source=lnt&amp;sa=X">Books</a></li><li><a href="http://pyvideo.org">Videos</a></li><li><a href="http://wiki.python.org/moin/BeginnersGuide">Beginner's Tutorials</a></li><li><a href="http://docs.python.org/library/">Libraries</a></li><li><a href="http://docs.python.org/devguide/">Core Develoment</a></li><li><a href="http://wiki.python.org/moin/">Wiki</a></li><li><a href="/pythonorg/default/index/dev/peps">PEPs</a></li></ul></li><li class="dropdown"><a href="#" onclick="javascript:void(0);return false;">Download</a><ul class="dropdown-menu"><li><a href="/pythonorg/default/index/download/windows">For Windows</a></li><li><a href="/pythonorg/default/index/download/mac">For Mac</a></li><li><a href="/pythonorg/default/index/download/source">For Linux</a></li><li><a href="/pythonorg/default/index/download/other">For other OS</a></li><li><a href="/pythonorg/default/index/download/releases">Old Releases</a></li></ul></li><li class="dropdown"><a href="#" onclick="javascript:void(0);return false;">Community</a><ul class="dropdown-menu"><li><a href="/pythonorg/default/index/community">Readme</a></li><li><a href="/pythonorg/default/index/community/lists">Mailing Lists</a></li><li><a href="/pythonorg/default/index/community/sigs">User Groups</a></li><li><a href="/pythonorg/default/index/community/workshops">Conferences</a></li><li><a href="/pythonorg/default/index/community/jobs">Jobs</a></li><li><a href="/pythonorg/default/index/community/awards">Awards</a></li><li><a href="/pythonorg/default/index/community/merchandise">Merchanise</a></li></ul></li><li class="dropdown"><a href="#" onclick="javascript:void(0);return false;">PSF</a><ul class="dropdown-menu"><li><a href="/pythonorg/default/index/psf">Readme</a></li><li><a href="/pythonorg/default/index/psf/about">About the PSF</a></li><li><a href="/pythonorg/default/index/psf/summary">Executive Summary</a></li><li><a href="/pythonorg/default/index/psf/mission">Mission Statement</a></li><li><a href="/pythonorg/default/index/psf/membership">Membership</a></li><li><a href="/pythonorg/default/index/psf/volunteer">Volunteer</a></li><li><a href="/pythonorg/default/index/psf/league">League</a></li><li><a href="/pythonorg/default/index/psf/committees">Committees</a></li><li><a href="/pythonorg/default/index/psf/bylaws">ByLaws</a></li><li><a href="/pythonorg/default/index/psf/reports">Reports</a></li><li><a href="http://wiki.python.org/moin/PythonSoftwareFoundation">Wiki</a></li><li><a href="http://pyfound.blogspot.com/">Weblog</a></li><li><a href="http://python.org/psf/press-release/">Press Releases</a></li><li><a href="/pythonorg/default/index/psf/forms">Forms</a></li></ul></li></ul>
	    
            <ul class="nav pull-right">
              <li>
                <a href="/pythonorg/default/edit/about/success/cog">
                  [en] Edit
                  <i class="icon-share-alt icon-white"> </i>
                </a>
              </li>	      
            </ul>
	    
          </div>
        </div>
      </div>
    </div>
    <div class="container">
      <!-- masthead ================================================== -->
      <header class="jumbotron subhead" id="overview">
	<img src="/pythonorg/static/images/logo.png" width="86px" align="left"/>
        <h1>
          python<small>.org</small>
        </h1>
        <p class="lead">
          The Programming Language of the Future
        </p>
      </header>
      <!-- content ================================================== -->
      <section id="content">
        <div class="page-header">
          <!--h1>
            typography
          </h1-->
        </div>
        <!-- headings & paragraph copy -->
        <div class="row">
          <div class="span8" id="content-main">
	    
<div id="rst-content">
  
  <p><strong>MISSING</strong>
<strong>MISSING</strong></p>
<div class="section" id="cog-a-code-generation-tool-written-in-python">
<h1>Cog: A Code Generation Tool Written in Python</h1>
<p><strong>MISSING</strong>
<strong>MISSING</strong>
<strong>Category:</strong>  Software Development, Business</p>
<p><strong>Keywords:</strong>  Code Generation, Database, XML, Collaboration Support, Groupware</p>
<p><strong>Title:</strong>  Cog: A Code Generation Tool Written in Python</p>
<p><strong>Author:</strong>   Ned Batchelder</p>
<p><strong>Date:</strong>   2004-06-01</p>
<p><strong>Website:</strong>  <a class="reference external" href="http://www.nedbatchelder.com/">http://www.nedbatchelder.com/</a></p>
<p><strong>Website:</strong>  <a class="reference external" href="http://www.kubisoftware.com/">http://www.kubisoftware.com/</a></p>
<p><strong>Summary:</strong>  Cog, a general-purpose Python-based code generation tool, is used to speed development of a collaboration system written in C++.</p>
<p><strong>Logo:</strong>  .. image:: /files/success/cog/batchelder-logo.gif    :alt: /files/success/cog/batchelder-logo.gif</p>
<div class="section" id="introduction">
<h2>Introduction</h2>
<p><a class="reference external" href="http://www.nedbatchelder.com/code/cog">Cog</a> is a simple code generation tool written in Python.  We use it or its
results every day in the production of Kubi.</p>
<p><a class="reference external" href="http://www.kubisoftware.com/">Kubi</a> is a collaboration system embodied in a handful of different products.
We have a schema that describes the representation of customers'
collaboration data: discussion topics, documents, calendar events, and so on.
This data has to be handled in many ways: stored in a number of different
data stores, shipped over the wire in an XML representation, manipulated in
memory using traditional C++ objects, presented for debugging, and reasoned
about to assess data validity, to name a few.</p>
<p>We needed a way to describe this schema once and then reliably produce
executable code from it.</p>
</div>
<div class="section" id="the-hard-way-with-c">
<h2>The Hard Way with C++</h2>
<p>Our first implementation of this schema involved a fractured collection of
representations. The XML protocol module had tables describing the
serialization and deserialization of XML streams.  The storage modules had
other tables describing the mapping from disk to memory structures.  The
validation module had its own tables containing rules about which properties
had to be present on which items.  The in-memory objects had getters and
setters for each property.</p>
<p>It worked, after a fashion, but was becoming unmanageable. Adding a new
property to the schema required editing ten tables in different formats in
as many source files, as well as adding getters and setters for the new
property. There was no single authority in the code for the schema as a
whole. Different aspects of the schema were represented in different
ways in different files.</p>
<p>We tried to simplify the mess using C++ macros. This worked to a degree, but
was still difficult to manage. The schema representation was hampered by the
simplistic nature of C++ macros, and the possibilities for expansion were
extremely limited.</p>
<p>The schema tables that could not be created with these primitive macros were
still composed and edited by hand. Changing a property in the schema still
meant touching a dozen files. This was tedious and error prone.  Missing one
place might introduce a bug that would go unnoticed for days.</p>
</div>
<div class="section" id="searching-for-a-better-way">
<h2>Searching for a Better Way</h2>
<p>It was becoming clear that we needed a better way to manage the property
schema. Not only were the existing modifications difficult, but new areas of
development were going to require new uses of the schema, and new kinds of
modification that would be even more onerous.</p>
<p>We'd been using C++ macros to try to turn a declarative description of the
schema into executable code.  The better way to do it is with code
generation: a program that writes programs.  We could use a tool to read the
schema and generate the C++ code, then compile that generated code into the
product.</p>
<p>We needed a way to read the schema description file and output pieces of code
that could be integrated into our C++ sources to be compiled with the rest of
the product.</p>
<p>Rather than write a program specific to our problem, I chose instead to write
a general-purpose, although simple, code generator tool.  It would solve the
problem of managing small chunks of generator code sprinkled throughout a
large collection of files.  We could then use this general purpose tool to
solve our specific generation problem.</p>
<p>The tool I wrote is called Cog.  Its requirements were:</p>
<ul class="simple">
<li>We needed to be able to perform interesting computation on the schema to create the code we needed.  Cog would have to provide a powerful language to write the code generators in.  An existing language would make it easier for developers to begin using Cog.</li>
<li>I wanted developers to be able to change the schema, and then run the tool without having to understand the complexities of the code generation. Cog would have to make it simple to combine the generated chunks of code with the rest of the C++ source, and it should be simple to run Cog to generate the final code.</li>
<li>The tool shouldn't care about the language of the host file.  We originally wanted to generate C++ files, but we were branching out into other languages. The generation process should be a pure text process, without regard to the eventual interpretation of that text.</li>
<li>Because the schema would change infrequently, the generation of code should be an edit-time activity, rather than a build-time activity.  This avoided having to run the code generator as part of the build, and meant that the generated code would be available to our IDE and debugger.</li>
</ul>
</div>
<div class="section" id="code-generation-with-python">
<h2>Code Generation with Python</h2>
<p>The language I chose for the code generators was, of course, Python. Its
simplicity and power are perfect for the job of reading data files and
producing code. To simplify the integration with the C++ code, the Python
generators are inserted directly into the C++ file as comments.</p>
<p>Cog reads a text file (C++ in our case), looking for specially-marked
sections of text, that it will use as generators.  It executes those sections
as Python code, capturing the output. The output is then spliced into the
file following the generator code.</p>
<p>Because the generator code and its output are both kept in the file, there is
no distinction between the input file and output file.   Cog reads and writes
the same file, and can be run over and over again without losing information.</p>
<img alt="Cog's Processing Model" src="/pythonorg/default/index/files/success/cog/cog-web.png" />
<p><em>Cog processes text files, converting specially marked sections of the file
into new content without disturbing the rest of the file or the sections
that it executes to produce the generated content.</em> <a class="reference external" href="/pythonorg/default/index/files/success/cog/cog.png">Zoom in</a></p>
<p>In addition to executing Python generators, Cog itself is written in Python.
Python's dynamic nature made it simple to execute the Python code Cog found,
and its flexibility made it possible to execute it in a properly-constructed
environment to get the desired semantics. Much of Cog's code is concerned
with getting indentation correct: I wanted the author to be able to organize
his generator code to look good in the host file, and produce generated code
that looked good as well, without worrying about fiddly whitespace issues.</p>
<p>Python's OS-level integration let me execute shell commands where needed. We
use Perforce for source control, which keeps files read-only until they need
to be edited.  When running Cog, it may need to change files that the
developer has not edited yet.  It can execute a shell command to check out
files that are read-only.</p>
<p>Lastly, we used XML for our new property schema description, and Python's
wide variety of XML processing libraries made parsing the XML a snap.</p>
</div>
<div class="section" id="an-example">
<h2>An Example</h2>
<p>Here's a concrete but slightly contrived example.  The properties are
described in an XML file:</p>
<pre class="code literal-block">
&lt;;!-- Properties.xml --&gt;
&lt;;props&gt;
        &lt;;property name='Id' type='String' /&gt;
        &lt;;property name='RevNum' type='Integer' /&gt;
        &lt;;property name='Subject' type='String' /&gt;
        &lt;;property name='ModDate' type='Date' /&gt;
&lt;;/props&gt;
</pre>
<p>We can write a C++ file with inlined Python code:</p>
<pre class="code literal-block">
// SchemaPropEnum.h
enum SchemaPropEnum {
        /* [[[cog
        import cog, handyxml
        for p in handyxml.xpath('Properties.xml', '//property'):
                cog.outl(&quot;Property%s,&quot; % p.name)
        ]]] */
        // [[[end]]]
};
</pre>
<p>After running this file through Cog, it looks like this:</p>
<pre class="code literal-block">
// SchemaPropEnum.h
enum SchemaPropEnum {
        /* [[[cog
        import cog, handyxml
        for p in handyxml.xpath('Properties.xml', '//property'):
                cog.outl(&quot;Property%s,&quot; % p.name)
        ]]] */
        PropertyId,
        PropertyRevNum,
        PropertySubject,
        PropertyModDate,
        // [[[end]]]
};
</pre>
<p>The lines with triple-brackets are marker lines that delimit the sections Cog
cares about. The text between the <strong>[[[cog</strong> and <strong>]]]</strong> lines is generator Python
code. The text between <strong>]]]</strong> and <strong>[[[end]]]</strong> is the output from the last run of
Cog (if any). For each chunk of generator code it finds, Cog will:</p>
<blockquote>
<ul class="simple">
<li>discard the output from the last run,</li>
<li>execute the generator code,</li>
<li>capture the output, from the cog.outl calls, and</li>
<li>insert the output back into the output section.</li>
</ul>
</blockquote>
</div>
<div class="section" id="how-it-worked-out">
<h2>How It Worked Out</h2>
<p>In a word, great.  We now have a powerful tool that lets us maintain a single
XML file that describes our data schema.  Developers changing the schema have
a simple tool to run that generates code from the schema, producing output
code in four different languages across 50 files.</p>
<p>Where we once used a repetitive and aggravating process that was inadequate
to our needs, we now have an automated process that lets developers express
themselves and have Cog do the hard work.</p>
<p>Python's flexibility and power were put to work in two ways: to develop Cog
itself, and sprinkled throughout our C++ source code to give our developers a
powerful tool to turn static data into running code.</p>
<p>Although our product is built in C++, we've used Python to increase our
productivity and expressive power, ease maintenance work, and automate
error-prone tasks.  Our shipping software is built every day with Python
hard at work behind the scenes.</p>
<p>More information, and Cog itself, is available at
<a class="reference external" href="http://www.nedbatchelder.com/code/cog">http://www.nedbatchelder.com/code/cog</a></p>
</div>
<div class="section" id="about-the-author">
<h2>About the Author</h2>
<p><em>Ned Batchelder is a professional software developer who struggles along with
C++, using Python to ease the friction every chance he gets. A previous
project of his,</em> <a class="reference external" href="/pythonorg/default/index/about/success/natsworld">Nat's World *was the subject of an earlier Python Success Story.*</a></p>
</div>
</div>

  <br/><br/>
</div>
<script>
  jQuery(function(){
    jQuery('.system-message').hide();
    jQuery('#rst-content p').each(function(i){
      if(jQuery(this).html().lastIndexOf('Published:',0)===0)
        jQuery(this).css('text-align','right').css('color','#aaa');
    });
  });
</script>


          </div>
	  
          <div class="span4">
	    <form class="well form-search" action="/pythonorg/default/search">
              <input type="text" name="keywords" class="input-medium search-query">
	      <button type="submit" class="btn">Search</button>
	    </form>
	    
            <div class="well" id="download">
	      <a href="/pythonorg/default/sync/download">Download Now!</a>
	      (<a href="http://wiki.python.org/moin/Python2orPython3">2.x or 3.x?</a>)
	    </div>
	    
	    
            <div class="well" id="toc"></div>
            <script>
	      jQuery(function(){jQuery('#toc').toc({
	      'selectors': 'h1,h2,h3',
	      'container': '#rst-content',
	      'smoothScrolling': true,
	      'prefix': 'toc',
	      'highlightOnScroll': true,
	      });});
            </script>	    
	    
	    <div class="well" id="python uses">
	      <h3>Using python for</h3>
	      <ul>
		<li>
		  <a href="http://wiki.python.org/moin/WebProgramming">Web</a>
		</li>
		<li>
		  <a href="http://wiki.python.org/moin/DatabaseProgramming">Database</a>
		</li>
		<li>
		  <a href="http://wiki.python.org/moin/GuiProgramming">GUI</a>
		</li>
		<li>
		  <a href="/pythonorg/default/index/about/apps">Networking</a>
		</li>
		<li>
		  <a href="/pythonorg/default/index/about/apps">Science</a>
		</li>
		<li>
		  <a href="/pythonorg/default/index/community/sigs/current/edu-sig">CS Education</a>
		</li>
		<li>
		  <a href="/pythonorg/default/index/about/apps">Games</a>
		</li>
		<li>
		  <a href="/pythonorg/default/index/about/apps">More</a>
		</li>
	      </ul>
	    </div>

<script charset="utf-8" src="http://widgets.twimg.com/j/2/widget.js"></script>
<script>
new TWTR.Widget({
  version: 2,
  type: 'profile',
  rpp: 4,
  interval: 30000,
  width: 'auto',
  height: 300,
  theme: {
    shell: {
      background: '#f2f2f2',
      color: '#ffffff'
    },
    tweets: {
      background: '#ffffff',
      color: '#3686b4',
      links: '#262626'
    }
  },
  features: {
    scrollbar: false,
    loop: false,
    live: false,
    behavior: 'all'
  }
}).render().setUser('ThePSF').start();
</script>
          </div>	
	  
        </div>
      </section><br /><br /><br /><br />
      <!-- footer ================================== -->
      <footer class="footer">
	<span class="auth_navbar"> [ <a href="/pythonorg/default/user/login?_next=/pythonorg/default/sync">Login</a> | <a href="/pythonorg/default/user/retrieve_username?_next=/pythonorg/default/sync">Forgot username?</a> | <a href="/pythonorg/default/user/request_reset_password?_next=/pythonorg/default/sync">Lost password?</a> ] </span>
        <p class="pull-right">
	  Copyright Â© 1990-2012, Python Software Foundation
          (<a href="/pythonorg/default/sync/about/legal">Legal Statements</a>)
        </p>
      </footer>
    </div>
    <!-- /container -->
    
    <!-- placed at the end of the document so the pages load faster -->
    <script src="/pythonorg/static/js/jquery.quovolver.js"></script>
    <script src="/pythonorg/static/bootswatch_files/bootstrap-dropdown.js"></script>
    <script src="/pythonorg/static/bootswatch_files/bootstrap-scrollspy.js"></script>
    <script src="/pythonorg/static/bootswatch_files/bootstrap-collapse.js"></script>
    <script src="/pythonorg/static/bootswatch_files/bootstrap-tooltip.js"></script>
    <script>
        jQuery(function(){
	  jQuery('.nav>li>a').each(function(){
	    if(jQuery(this).parent().find('ul').length)
	      jQuery(this).attr({'class':'dropdown-toggle','data-toggle':'dropdown'}).append('<b class="caret"></b>');
          });	
        });
      </script>
    <script type="text/javascript" src="/pythonorg/static/js/jquerytypewriter.js"></script>
    <script src="/pythonorg/static/js/share.js?static=%2Fpythonorg%2Fstatic%2Fimages"></script>
    <script type="text/javascript"> var _gaq = _gaq || []; _gaq.push(['_setAccount', 'unknown']); _gaq.push(['_trackPageview']); (function() { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s); })(); </script> 
  </body>
</html>
    
